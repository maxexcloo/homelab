[tools]
opentofu = "latest"

[env]
TF_CLI_ARGS_init = "-upgrade"
TF_CLI_ARGS_plan = "-compact-warnings"
TF_CLI_ARGS_apply = "-compact-warnings"

# Setup & Initialize
[tasks.setup]
description = "Initial project setup"
run = """
echo "ðŸ”§ Setting up project..."

# Check 1Password CLI
if ! command -v op &> /dev/null; then
    echo "âŒ 1Password CLI not installed"
    echo "ðŸ‘‰ Install from: https://1password.com/downloads/command-line/"
    exit 1
fi

# Check for required tokens
if [[ ! -f .mise.local.toml ]]; then
    echo "ðŸ“„ Creating .mise.local.toml template..."
    cat > .mise.local.toml << 'EOF'
[env]
# 1Password Service Account Token
# Create at: https://my.1password.com/integrations/active
OP_SERVICE_ACCOUNT_TOKEN = "REPLACE_ME"

# HCP Terraform Token  
# Create at: https://app.terraform.io/app/settings/tokens
TF_TOKEN_app_terraform_io = "REPLACE_ME"
EOF
    echo "âœ… Created .mise.local.toml - please add your tokens"
fi

# Create providers entry in 1Password if it doesn't exist
echo "ðŸ”‘ Checking providers entry..."
if ! op item get "providers" --vault "Infrastructure" 2>/dev/null; then
    echo "ðŸ“ Creating providers entry with all fields..."
    op item create \
        --category="Login" \
        --title="providers" \
        --vault="Infrastructure" || echo "âŒ Failed to create providers entry"
    
    # Add all provider fields
    echo "ðŸ“‹ Adding provider fields..."
    op item edit --vault="Infrastructure" "providers" \
        'b2.application_key[concealed]=REPLACE_ME' \
        'b2.application_key_id[text]=REPLACE_ME' \
        'cloudflare.account_id[text]=REPLACE_ME' \
        'cloudflare.api_token[concealed]=REPLACE_ME' \
        'github.token[concealed]=REPLACE_ME' \
        'oci.fingerprint[text]=REPLACE_ME' \
        'oci.private_key[concealed]=REPLACE_ME' \
        'oci.region[text]=ap-sydney-1' \
        'oci.tenancy_ocid[text]=REPLACE_ME' \
        'oci.user_ocid[text]=REPLACE_ME' \
        'proxmox-default.endpoint[url]=https://proxmox.example.com:8006' \
        'proxmox-default.password[concealed]=REPLACE_ME' \
        'proxmox-default.username[text]=root' \
        'resend.api_key[concealed]=REPLACE_ME' \
        'tailscale.oauth_client_id[text]=REPLACE_ME' \
        'tailscale.oauth_client_secret[concealed]=REPLACE_ME' \
        'tailscale.tailnet[text]=REPLACE_ME' 2>/dev/null || echo "âš ï¸  Could not add all provider fields"
else
    echo "âœ… Providers entry exists"
fi

echo "âœ… Setup complete!"
"""

[tasks.init]
description = "Initialize OpenTofu"
depends = ["init:infrastructure", "init:services"]

[tasks."init:infrastructure"]
description = "Initialize infrastructure"
run = "cd infrastructure && tofu init"

[tasks."init:services"]
description = "Initialize services"
run = "cd services && tofu init"

# Development
[tasks.check]
description = "Format and validate"
depends = ["fmt", "validate"]

[tasks.fmt]
description = "Format all files"
run = "tofu fmt -recursive ."

[tasks.validate]
description = "Validate configurations"
run = """
cd infrastructure && tofu validate && cd ..
cd services && tofu validate && cd ..
"""

# Plan & Apply
[tasks.plan]
description = "Plan all changes"
depends = ["plan:infrastructure", "plan:services"]

[tasks."plan:infrastructure"]
description = "Plan infrastructure"
run = """
# Plan infrastructure
TF_VAR_proxmox_servers=$(op item get providers --vault Infrastructure --format json | jq -c '[.fields[] | select(.section) | select(.section.label | startswith("proxmox-"))] | group_by(.section.label) | map({key: (.[0].section.label | sub("proxmox-"; "")), value: (map({(.label): .value}) | add) }) | from_entries')
cd infrastructure
tofu plan
"""

[tasks."plan:services"]
description = "Plan services"
run = "cd services && tofu plan"

[tasks.apply]
description = "Apply all changes"
depends = ["apply:infrastructure", "apply:services"]

[tasks."apply:infrastructure"]
description = "Apply infrastructure"
run = """
# Apply infrastructure
TF_VAR_proxmox_servers=$(op item get providers --vault Infrastructure --format json | jq -c '[.fields[] | select(.section) | select(.section.label | startswith("proxmox-"))] | group_by(.section.label) | map({key: (.[0].section.label | sub("proxmox-"; "")), value: (map({(.label): .value}) | add) }) | from_entries')
cd infrastructure
if [[ -n "$CI" ]] || [[ "$MISE_YES" == "true" ]]; then
  tofu apply -auto-approve
else
  tofu apply
fi
"""

[tasks."apply:services"]
description = "Apply services"
run = """
cd services
if [[ -n "$CI" ]] || [[ "$MISE_YES" == "true" ]]; then
  tofu apply -auto-approve
else
  tofu apply
fi
"""

# Maintenance
[tasks.refresh]
description = "Check for configuration drift"
run = """
echo "ðŸ” Checking for drift..."
cd infrastructure && tofu refresh && cd ..
cd services && tofu refresh && cd ..
"""

[tasks.clean]
description = "Clean up generated files"
run = """
find . -name '.terraform.lock.hcl' -delete 2>/dev/null || true
find . -name '.terraform' -type d -exec rm -rf {} + 2>/dev/null || true
find . -name '*.tfplan' -delete 2>/dev/null || true
echo "âœ… Cleaned up generated files"
"""
